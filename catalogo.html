<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catálogo Digital - Ciervo Administrativo</title>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.js"></script>
    <style>
        /* ================================
           ESTILOS BASE (Heredados)
           ================================ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #dbeafe, #e0e7ff);
            min-height: 100vh;
            color: #334155;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-mode {
            background: linear-gradient(to bottom right, #1a202c, #2d3748, #4a5568);
            color: #e2e8f0;
        }

        .container { max-width: 1280px; margin: 0 auto; padding: 0 1.5rem; }

        /* ================================
           BARRA SUPERIOR (Glassmorphic)
           ================================ */
        .glassmorphic-bar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        body.dark-mode .glassmorphic-bar {
            background: rgba(26, 32, 44, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .brand-section { display: flex; align-items: center; gap: 1rem; }

        .brand-icon {
            width: 48px; height: 48px;
            background: linear-gradient(to bottom right, #3b82f6, #9333ea);
            border-radius: 16px;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.25);
        }

        .brand-text h1 {
            font-size: 1.25rem; font-weight: bold;
            background: linear-gradient(to right, #1e293b, #64748b);
            -webkit-background-clip: text; color: transparent;
        }

        body.dark-mode .brand-text h1 {
            background: linear-gradient(to right, #e2e8f0, #cbd5e0);
            -webkit-background-clip: text; color: transparent;
        }

        .brand-text p { font-size: 0.875rem; color: #64748b; }
        body.dark-mode .brand-text p { color: #a0aec0; }

        .back-button {
            display: flex; align-items: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.5);
            color: #64748b; border: none; border-radius: 12px;
            text-decoration: none; font-weight: 500; font-size: 0.875rem;
            cursor: pointer; transition: all 0.2s; backdrop-filter: blur(8px);
        }

        body.dark-mode .back-button {
            background: rgba(45, 55, 72, 0.5); color: #a0aec0;
        }

        .back-button:hover { transform: translateX(-2px); background: rgba(255, 255, 255, 0.8); }
        body.dark-mode .back-button:hover { background: rgba(45, 55, 72, 0.8); color: #e2e8f0; }

        .theme-toggle {
            background: none; border: none; cursor: pointer;
            color: #64748b; transition: color 0.3s; margin-right: 1rem;
        }
        body.dark-mode .theme-toggle { color: #e2e8f0; }

        /* ================================
           CONTENIDO PRINCIPAL
           ================================ */
        .main-content { padding: 2rem 0; }

        .page-header { text-align: center; margin-bottom: 3rem; }

        .page-title {
            font-size: 2.25rem; font-weight: bold; margin-bottom: 1rem;
            background: linear-gradient(to right, #1e293b, #1e40af, #7c3aed);
            -webkit-background-clip: text; color: transparent;
        }
        body.dark-mode .page-title {
            background: linear-gradient(to right, #e2e8f0, #90cdf4, #a78bfa);
            -webkit-background-clip: text; color: transparent;
        }

        .page-subtitle { color: #64748b; font-size: 1.125rem; }
        body.dark-mode .page-subtitle { color: #a0aec0; }

        /* ================================
           BARRA DE ACCIONES
           ================================ */
        .action-bar {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 2rem; gap: 1rem; flex-wrap: wrap;
        }

        .search-container { position: relative; flex: 1; min-width: 300px; }

        .search-input {
            width: 100%; padding: 0.75rem 1rem 0.75rem 3rem;
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.7); color: #1e293b;
            backdrop-filter: blur(8px); transition: all 0.2s;
        }
        body.dark-mode .search-input {
            background: rgba(45, 55, 72, 0.7); border-color: rgba(255, 255, 255, 0.1); color: #e2e8f0;
        }
        .search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1); }

        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: #64748b; }

        .view-toggles {
            display: flex; background: rgba(255,255,255,0.5);
            padding: 4px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.2);
        }
        body.dark-mode .view-toggles { background: rgba(45,55,72,0.5); border-color: rgba(255,255,255,0.1); }

        .view-btn {
            padding: 0.5rem 1rem; border: none; background: none;
            cursor: pointer; border-radius: 8px; color: #64748b;
            display: flex; align-items: center; gap: 0.5rem; font-weight: 500;
        }
        body.dark-mode .view-btn { color: #a0aec0; }

        .view-btn.active { background: white; color: #3b82f6; shadow: 0 2px 4px rgba(0,0,0,0.1); }
        body.dark-mode .view-btn.active { background: #4a5568; color: #90cdf4; }

        /* ================================
           VISTA DE TABLA (LISTA)
           ================================ */
        .catalog-container {
            background: white; border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e2e8f0; overflow: hidden;
            display: none; /* Hidden by default if grid is active */
        }
        body.dark-mode .catalog-container {
            background: #2d3748; border-color: #4a5568;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.3);
        }
        .catalog-container.active { display: block; }

        .catalog-table { width: 100%; border-collapse: collapse; }
        .catalog-table th {
            padding: 1rem; text-align: left; font-weight: 600;
            background: #f8fafc; color: #374151; border-bottom: 1px solid #e2e8f0;
        }
        body.dark-mode .catalog-table th { background: #1a202c; color: #cbd5e0; border-color: #4a5568; }
        
        .catalog-table td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid #f1f5f9; }
        body.dark-mode .catalog-table td { border-color: #4a5568; }

        .status-badge {
            display: inline-flex; align-items: center; gap: 0.25rem;
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;
        }
        .status-visible { background: #dcfce7; color: #166534; }
        body.dark-mode .status-visible { background: #2f574e; color: #68d391; }
        .status-hidden { background: #f1f5f9; color: #64748b; }
        body.dark-mode .status-hidden { background: #4a5568; color: #a0aec0; }

        .btn-icon {
            padding: 0.5rem; border: none; border-radius: 8px; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            background: #dbeafe; color: #2563eb; transition: all 0.2s;
        }
        body.dark-mode .btn-icon { background: #426a9e; color: #90cdf4; }
        .btn-icon:hover { transform: scale(1.05); }

        /* ================================
           VISTA DE TARJETAS (GRID)
           ================================ */
        .catalog-grid {
            display: none; /* Hidden by default */
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }
        .catalog-grid.active { display: grid; }

        .product-card {
            background: white; border-radius: 20px;
            border: 1px solid #e2e8f0; overflow: hidden;
            transition: all 0.3s ease; position: relative;
            display: flex; flex-direction: column;
        }
        body.dark-mode .product-card { background: #2d3748; border-color: #4a5568; }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .card-image-container {
            height: 200px; background: #f1f5f9;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; position: relative;
        }
        body.dark-mode .card-image-container { background: #1a202c; }

        .card-image { width: 100%; height: 100%; object-fit: cover; }
        
        .no-image-placeholder {
            display: flex; flex-direction: column; align-items: center; gap: 0.5rem; color: #94a3b8;
        }

        .card-content { padding: 1.5rem; flex: 1; display: flex; flex-direction: column; }

        .card-category { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 600; margin-bottom: 0.5rem; }
        body.dark-mode .card-category { color: #a0aec0; }

        .card-title { font-size: 1.125rem; font-weight: bold; margin-bottom: 0.5rem; color: #1e293b; line-height: 1.4; }
        body.dark-mode .card-title { color: #e2e8f0; }

        .card-price { font-size: 1.25rem; font-weight: 700; color: #3b82f6; margin-bottom: 1rem; }
        body.dark-mode .card-price { color: #90cdf4; }

        .card-footer {
            margin-top: auto; padding-top: 1rem; border-top: 1px solid #f1f5f9;
            display: flex; justify-content: space-between; align-items: center;
        }
        body.dark-mode .card-footer { border-color: #4a5568; }

        /* ================================
           MODAL Y PESTAÑAS
           ================================ */
        .modal {
            position: fixed; inset: 0; z-index: 100;
            display: none; align-items: center; justify-content: center;
            background: rgba(0, 0, 0, 0.5); backdrop-filter: blur(5px);
        }
        .modal.show { display: flex; }

        .modal-content {
            background: white; border-radius: 24px;
            width: 90%; max-width: 700px; max-height: 90vh;
            overflow-y: auto; display: flex; flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        body.dark-mode .modal-content { background: #2d3748; }

        .modal-header {
            padding: 1.5rem; border-bottom: 1px solid #e2e8f0;
            display: flex; justify-content: space-between; align-items: center;
        }
        body.dark-mode .modal-header { border-color: #4a5568; }

        .close-button { background: none; border: none; cursor: pointer; color: #64748b; }
        body.dark-mode .close-button { color: #a0aec0; }

        /* Estilos de Pestañas */
        .tabs-nav {
            display: flex; padding: 0 1.5rem; border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }
        body.dark-mode .tabs-nav { background: #1a202c; border-color: #4a5568; }

        .tab-btn {
            padding: 1rem 1.5rem; border: none; background: none;
            cursor: pointer; font-weight: 500; color: #64748b;
            border-bottom: 2px solid transparent; transition: all 0.2s;
        }
        body.dark-mode .tab-btn { color: #a0aec0; }

        .tab-btn.active { color: #3b82f6; border-bottom-color: #3b82f6; }
        body.dark-mode .tab-btn.active { color: #90cdf4; border-bottom-color: #90cdf4; }

        .tab-content { padding: 2rem; display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Formularios */
        .form-group { margin-bottom: 1.25rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #374151; }
        body.dark-mode .form-label { color: #cbd5e0; }

        .form-input, .form-textarea {
            width: 100%; padding: 0.75rem; border-radius: 8px;
            border: 1px solid #d1d5db; background: white; color: #1e293b;
        }
        body.dark-mode .form-input, body.dark-mode .form-textarea {
            background: #1a202c; border-color: #4a5568; color: #e2e8f0;
        }

        .form-input:disabled { background: #f3f4f6; cursor: not-allowed; }
        body.dark-mode .form-input:disabled { background: #2d3748; }
        
        .modal-footer {
            padding: 1.5rem; border-top: 1px solid #e2e8f0;
            display: flex; justify-content: flex-end; gap: 1rem;
        }
        body.dark-mode .modal-footer { border-color: #4a5568; }

        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #6366f1);
            color: white; border: none; padding: 0.75rem 1.5rem;
            border-radius: 8px; font-weight: 500; cursor: pointer;
        }
        
        /* Switch Toggle */
        .switch { position: relative; display: inline-block; width: 50px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #ccc; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 16px; width: 16px;
            left: 4px; bottom: 4px; background-color: white;
            transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(26px); }

        /* ================================
           NUEVOS ESTILOS: VISOR DE GALERÍA Y ZOOM
           ================================ */
        .gallery-container {
            margin-bottom: 2rem;
            background: #f8fafc;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        body.dark-mode .gallery-container {
            background: #1a202c;
            border-color: #4a5568;
        }

        .viewer-wrapper {
            position: relative;
            height: 300px; /* Altura fija para el visor */
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
            background-size: 20px 20px;
        }
        body.dark-mode .viewer-wrapper {
            background-image: radial-gradient(#4a5568 1px, transparent 1px);
        }

        .viewer-image {
            max-height: 100%;
            max-width: 100%;
            object-fit: contain;
            /* FIX DE ARRASTRE */
            transform-origin: center center;
            user-select: none;
            -webkit-user-select: none;
            -webkit-user-drag: none; /* Evita el "fantasma" nativo */
            transition: transform 0.1s linear; /* Transición rápida para arrastre */
            cursor: grab;
        }
        .viewer-image:active { cursor: grabbing; }

        /* Controles Flotantes */
        .viewer-controls {
            position: absolute;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            padding: 0.5rem;
            border-radius: 99px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }
        body.dark-mode .viewer-controls {
            background: rgba(26, 32, 44, 0.8);
        }

        .control-btn {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: none;
            background: white;
            color: #475569;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        body.dark-mode .control-btn { background: #2d3748; color: #e2e8f0; }
        .control-btn:hover { background: #3b82f6; color: white; transform: translateY(-2px); }

        /* Indicador de "Imagen Principal" */
        .main-badge {
            position: absolute;
            top: 1rem; right: 1rem;
            background: #f59e0b;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 99px;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            display: flex; align-items: center; gap: 0.25rem;
            z-index: 10;
        }

        /* Inputs de URL */
        .url-inputs-list {
            display: flex; flex-direction: column; gap: 0.75rem;
            padding: 1rem;
            background: rgba(255,255,255,0.5);
        }
        .url-row { display: flex; gap: 0.5rem; align-items: center; }
        .url-indicator {
            width: 24px; height: 24px;
            border-radius: 50%;
            background: #cbd5e1;
            color: white;
            font-size: 0.75rem;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }
        .active-row .url-indicator { background: #3b82f6; }

        /* Botón de Búsqueda Google */
        .google-search-btn {
            width: 100%;
            margin-bottom: 0.75rem;
            display: flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.5rem;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            color: #4b5563;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        .google-search-btn:hover { background: #f1f5f9; border-color: #9ca3af; }
        body.dark-mode .google-search-btn {
            background: #2d3748; border-color: #4a5568; color: #cbd5e0;
        }
        body.dark-mode .google-search-btn:hover { background: #4a5568; }

    </style>
</head>
<body>

    <div class="glassmorphic-bar">
        <div class="container">
            <div class="top-bar">
                <div class="brand-section">
                    <div class="brand-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                            <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                        </svg>
                    </div>
                    <div class="brand-text">
                        <h1>Catálogo Digital</h1>
                        <p>Gestión de Productos y Multimedia</p>
                    </div>
                </div>
                
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="theme-toggle" onclick="toggleDarkMode()">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon">
                            <circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon" style="display: none;">
                            <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>
                        </svg>
                    </button>
                    <a href="menu.html" class="back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 12H6m0 0l6 6m-6-6l6-6"/>
                        </svg>
                        <span>Volver al Menú</span>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container main-content">
        <div class="page-header">
            <h2 class="page-title">Catálogo de Productos</h2>
            <p class="page-subtitle">Enriquece la información de tus productos y gestiona su presentación pública.</p>
        </div>

        <div class="action-bar">
            <div class="search-container">
                <input type="text" class="search-input" id="searchInput" placeholder="Buscar por nombre, código o categoría...">
                <svg xmlns="http://www.w3.org/2000/svg" class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
                </svg>
            </div>

            <div class="view-toggles">
                <button class="view-btn active" id="btnListView" onclick="switchView('list')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
                    Lista
                </button>
                <button class="view-btn" id="btnGridView" onclick="switchView('grid')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    Tarjetas
                </button>
            </div>
        </div>

        <div class="catalog-container active" id="listView">
            <table class="catalog-table">
                <thead>
                    <tr>
                        <th>Imagen</th>
                        <th>Producto</th>
                        <th>Categoría</th>
                        <th>Precio Venta</th>
                        <th>Estado</th>
                        <th>Acción</th>
                    </tr>
                </thead>
                <tbody id="catalogTableBody">
                    </tbody>
            </table>
        </div>

        <div class="catalog-grid" id="gridView">
            </div>

    </div>

    <div class="modal" id="catalogModal">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h3 style="font-size: 1.25rem; font-weight: bold; color: #1e293b;" id="modalTitle">Detalles del Producto</h3>
                    <p style="font-size: 0.875rem; color: #64748b;" id="modalSubtitle">Editando información y multimedia</p>
                </div>
                <button class="close-button" onclick="closeModal()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                </button>
            </div>

            <div class="tabs-nav">
                <button class="tab-btn active" onclick="switchTab('tabGeneral')">Galería y General</button>
                <button class="tab-btn" onclick="switchTab('tabSpecs')">Especificaciones</button>
            </div>

            <div class="modal-body" style="padding: 0;">
                <form id="catalogForm">
                    
                    <div id="tabGeneral" class="tab-content active">
                        
                        <div class="gallery-container">
                            <div class="viewer-wrapper">
                                <div id="mainImageBadge" class="main-badge" style="display: none;">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    PORTADA
                                </div>
                                
                                <img id="viewerImage" src="" class="viewer-image" alt="Vista previa">
                                
                                <div class="viewer-controls">
                                    <button type="button" class="control-btn" onclick="galleryAction('prev')" title="Anterior">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg>
                                    </button>
                                    <button type="button" class="control-btn" onclick="galleryAction('zoomOut')" title="Reducir Zoom">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
                                    </button>
                                    <button type="button" class="control-btn" onclick="galleryAction('zoomIn')" title="Aumentar Zoom">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
                                    </button>
                                    <button type="button" class="control-btn" onclick="galleryAction('setMain')" title="Establecer como Portada">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                                    </button>
                                    <button type="button" class="control-btn" onclick="galleryAction('next')" title="Siguiente">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
                                    </button>
                                </div>
                            </div>

                            <div class="url-inputs-list">
                                <button type="button" class="google-search-btn" onclick="searchGoogleImages()">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                                    Buscar imágenes del producto en Google
                                </button>

                                <div class="url-row" id="row-0">
                                    <div class="url-indicator">1</div>
                                    <input type="text" id="imgUrl0" class="form-input" placeholder="URL Imagen 1" onchange="updateGalleryFromInputs()">
                                </div>
                                <div class="url-row" id="row-1">
                                    <div class="url-indicator">2</div>
                                    <input type="text" id="imgUrl1" class="form-input" placeholder="URL Imagen 2 (Opcional)" onchange="updateGalleryFromInputs()">
                                </div>
                                <div class="url-row" id="row-2">
                                    <div class="url-indicator">3</div>
                                    <input type="text" id="imgUrl2" class="form-input" placeholder="URL Imagen 3 (Opcional)" onchange="updateGalleryFromInputs()">
                                </div>
                                <small style="color: #64748b; margin-top: 5px; display: block;">* Usa las flechas del visor para navegar. El botón <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg> define la imagen que se ve en el catálogo.</small>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Nombre del Producto (Inventario)</label>
                            <input type="text" id="productName" class="form-input" disabled>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Descripción Comercial</label>
                            <textarea id="productDescription" class="form-textarea" rows="3" placeholder="Descripción detallada para el cliente..."></textarea>
                        </div>

                        <div class="form-group" style="display: flex; align-items: center; gap: 1rem; margin-top: 1.5rem;">
                            <label class="switch">
                                <input type="checkbox" id="productVisible">
                                <span class="slider"></span>
                            </label>
                            <span style="font-weight: 500;">Visible en el Catálogo</span>
                        </div>
                    </div>

                    <div id="tabSpecs" class="tab-content">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                            <div class="form-group">
                                <label class="form-label">Color</label>
                                <input type="text" id="specColor" class="form-input" placeholder="Ej: Rojo, Azul Medianoche">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Material</label>
                                <input type="text" id="specMaterial" class="form-input" placeholder="Ej: Algodón, Acero Inoxidable">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Dimensiones</label>
                                <input type="text" id="specDimensions" class="form-input" placeholder="Ej: 30x40 cm">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Peso</label>
                                <input type="text" id="specWeight" class="form-input" placeholder="Ej: 1.5 kg">
                            </div>
                            <div class="form-group" style="grid-column: span 2;">
                                <label class="form-label">Modelo / Referencia</label>
                                <input type="text" id="specModel" class="form-input" placeholder="Ej: XYZ-2023">
                            </div>
                        </div>
                    </div>

                </form>
            </div>

            <div class="modal-footer">
                <button class="btn-primary" onclick="saveCatalogChanges()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // GESTIÓN DE DATOS
        // ================================
        let products = [];
        let currentEditingId = null;

        // ESTADO DE LA GALERÍA LOCAL (CON PANNING)
        let galleryState = {
            urls: ['', '', ''],
            currentIndex: 0,
            mainIndex: 0,
            zoom: 1,
            // Variables para el arrastre
            panX: 0,
            panY: 0,
            isDragging: false,
            startX: 0,
            startY: 0
        };

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            applySavedTheme();
            loadProducts();
            setupGalleryEvents(); // Iniciar eventos de mouse
            
            // Listener para búsqueda
            document.getElementById('searchInput').addEventListener('input', (e) => {
                renderAll(e.target.value);
            });
        });

        // ================================
        // EVENTOS DE GALERÍA (Mouse & Touch)
        // ================================
        function setupGalleryEvents() {
            const img = document.getElementById('viewerImage');
            const container = document.querySelector('.viewer-wrapper');

            // Prevenir comportamiento nativo de arrastre (Fix Ghosting)
            img.addEventListener('dragstart', (e) => e.preventDefault());

            // MOUSE DOWN: Iniciar arrastre
            container.addEventListener('mousedown', (e) => {
                if (galleryState.zoom > 1) { // Solo si hay zoom
                    galleryState.isDragging = true;
                    // Calculamos la posición inicial relativa al pan actual
                    galleryState.startX = e.clientX - galleryState.panX;
                    galleryState.startY = e.clientY - galleryState.panY;
                    container.style.cursor = 'grabbing';
                }
            });

            // MOUSE MOVE: Mover imagen
            window.addEventListener('mousemove', (e) => {
                if (galleryState.isDragging) {
                    e.preventDefault();
                    galleryState.panX = e.clientX - galleryState.startX;
                    galleryState.panY = e.clientY - galleryState.startY;
                    updateTransform();
                }
            });

            // MOUSE UP: Terminar arrastre
            window.addEventListener('mouseup', () => {
                galleryState.isDragging = false;
                // Restaurar cursor si seguimos en zoom
                if (galleryState.zoom > 1) {
                    const img = document.getElementById('viewerImage');
                    img.style.cursor = 'grab';
                }
            });
            
            // SOPORTE TÁCTIL (Móvil)
            container.addEventListener('touchstart', (e) => {
                 if (galleryState.zoom > 1) {
                    galleryState.isDragging = true;
                    galleryState.startX = e.touches[0].clientX - galleryState.panX;
                    galleryState.startY = e.touches[0].clientY - galleryState.panY;
                 }
            });
            
            window.addEventListener('touchmove', (e) => {
                if (galleryState.isDragging) {
                    galleryState.panX = e.touches[0].clientX - galleryState.startX;
                    galleryState.panY = e.touches[0].clientY - galleryState.startY;
                    updateTransform();
                }
            });
            
            window.addEventListener('touchend', () => {
                galleryState.isDragging = false;
            });
        }

        // ================================
        // FUNCIONES DE GALERÍA
        // ================================
        function galleryAction(action) {
            switch(action) {
                case 'next':
                    galleryState.currentIndex = (galleryState.currentIndex + 1) % 3;
                    resetView(); 
                    updateViewerUI();
                    break;
                case 'prev':
                    galleryState.currentIndex = (galleryState.currentIndex - 1 + 3) % 3;
                    resetView();
                    updateViewerUI();
                    break;
                case 'zoomIn':
                    galleryState.zoom = Math.min(galleryState.zoom + 0.5, 3);
                    updateTransform();
                    break;
                case 'zoomOut':
                    galleryState.zoom = Math.max(galleryState.zoom - 0.5, 1);
                    if (galleryState.zoom === 1) {
                        galleryState.panX = 0;
                        galleryState.panY = 0;
                    }
                    updateTransform();
                    break;
                case 'setMain':
                    galleryState.mainIndex = galleryState.currentIndex;
                    updateViewerUI();
                    break;
            }
        }

        function resetView() {
            galleryState.zoom = 1;
            galleryState.panX = 0;
            galleryState.panY = 0;
            updateTransform();
        }

        function updateTransform() {
            const img = document.getElementById('viewerImage');
            // Aplicar traslación Y escala
            img.style.transform = `translate(${galleryState.panX}px, ${galleryState.panY}px) scale(${galleryState.zoom})`;
            
            // Cursor inteligente
            if (galleryState.zoom > 1) {
                img.style.cursor = galleryState.isDragging ? 'grabbing' : 'grab';
            } else {
                img.style.cursor = 'default';
            }
        }

        function updateViewerUI() {
            const currentUrl = document.getElementById(`imgUrl${galleryState.currentIndex}`).value;
            const imgElement = document.getElementById('viewerImage');
            
            if (currentUrl && currentUrl.trim() !== '') {
                imgElement.src = currentUrl;
                imgElement.style.display = 'block';
            } else {
                imgElement.src = 'https://via.placeholder.com/400x300?text=Sin+Imagen'; 
            }

            [0, 1, 2].forEach(i => {
                const row = document.getElementById(`row-${i}`);
                if (i === galleryState.currentIndex) row.classList.add('active-row');
                else row.classList.remove('active-row');
            });

            const badge = document.getElementById('mainImageBadge');
            badge.style.display = (galleryState.currentIndex === galleryState.mainIndex) ? 'flex' : 'none';
        }

        function updateGalleryFromInputs() {
            galleryState.urls = [
                document.getElementById('imgUrl0').value,
                document.getElementById('imgUrl1').value,
                document.getElementById('imgUrl2').value
            ];
            updateViewerUI();
        }
        
        function searchGoogleImages() {
            const name = document.getElementById('productName').value;
            if (name) {
                const query = encodeURIComponent(name);
                window.open(`https://www.google.com/search?tbm=isch&q=${query}`, '_blank');
            } else {
                alert('El producto no tiene nombre para buscar.');
            }
        }

        // ================================
        // CARGA Y GUARDADO
        // ================================
        function loadProducts() {
            const stored = localStorage.getItem('ciervo_inventory');
            if (stored) {
                products = JSON.parse(stored);
                products.forEach(p => {
                    if (typeof p.visible === 'undefined') p.visible = true; 
                    if (!p.images) {
                        p.images = [p.imageUrl || '', '', ''];
                        p.mainImageIndex = 0;
                    }
                    while(p.images.length < 3) p.images.push('');
                    if (!p.specs) p.specs = { color: '', material: '', dimensions: '', weight: '', model: '' };
                });
                renderAll();
            }
        }

        function saveProducts() {
            localStorage.setItem('ciervo_inventory', JSON.stringify(products));
            renderAll();
            window.dispatchEvent(new CustomEvent('ciervoSync', { detail: { store: 'inventory', data: products } }));
        }

        // ================================
        // RENDERIZADO
        // ================================
        function renderAll(searchTerm = '') {
            const filtered = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                (p.code && p.code.toLowerCase().includes(searchTerm.toLowerCase()))
            );
            renderTable(filtered);
            renderGrid(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('catalogTableBody');
            tbody.innerHTML = '';
            data.forEach(p => {
                const mainImg = p.images && p.images[p.mainImageIndex || 0] ? p.images[p.mainImageIndex || 0] : '';
                const imgIcon = mainImg 
                    ? `<img src="${mainImg}" style="width:32px; height:32px; border-radius:6px; object-fit:cover;">`
                    : `<div style="width:32px; height:32px; background:#f1f5f9; border-radius:6px; display:flex; align-items:center; justify-content:center; color:#94a3b8;"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg></div>`;

                const row = `
                    <tr>
                        <td>${imgIcon}</td>
                        <td>
                            <div style="font-weight:500;">${p.name}</div>
                            <div style="font-size:0.75rem; color:#64748b;">${p.code || 'S/C'}</div>
                        </td>
                        <td>${p.category || 'General'}</td>
                        <td>$${(p.isBulk ? p.pricePerUnit : p.price).toFixed(2)}</td>
                        <td><span class="status-badge ${p.visible ? 'status-visible' : 'status-hidden'}">${p.visible ? 'Visible' : 'Oculto'}</span></td>
                        <td>
                            <button class="btn-icon" onclick="openEditModal(${p.id})">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                            </button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        }

        function renderGrid(data) {
            const grid = document.getElementById('gridView');
            grid.innerHTML = '';
            data.forEach(p => {
                const mainImg = p.images && p.images[p.mainImageIndex || 0] ? p.images[p.mainImageIndex || 0] : '';
                const imgHtml = mainImg 
                    ? `<img src="${mainImg}" class="card-image" onerror="this.src='https://via.placeholder.com/300?text=Error+Imagen'">`
                    : `<div class="no-image-placeholder"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><span>Sin imagen</span></div>`;

                const card = `
                    <div class="product-card" onclick="openEditModal(${p.id})" style="cursor:pointer; opacity: ${p.visible ? 1 : 0.6};">
                        <div class="card-image-container">
                            ${imgHtml}
                            ${!p.visible ? '<span style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:2px 8px; border-radius:99px; font-size:0.7rem;">Oculto</span>' : ''}
                        </div>
                        <div class="card-content">
                            <div class="card-category">${p.category || 'General'}</div>
                            <div class="card-title">${p.name}</div>
                            <div class="card-price">$${(p.isBulk ? p.pricePerUnit : p.price).toFixed(2)}</div>
                            <div class="card-footer">
                                <span style="font-size:0.8rem; color:#64748b;">${p.code || ''}</span>
                                <button class="btn-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></button>
                            </div>
                        </div>
                    </div>`;
                grid.innerHTML += card;
            });
        }

        // ================================
        // MODAL Y EDICIÓN
        // ================================
        function openEditModal(id) {
            currentEditingId = id;
            const p = products.find(prod => prod.id === id);
            if (!p) return;

            // 1. Inicializar Estado
            galleryState = {
                urls: [...p.images],
                currentIndex: 0,
                mainIndex: p.mainImageIndex || 0,
                zoom: 1,
                panX: 0, panY: 0, isDragging: false, startX: 0, startY: 0
            };

            // 2. UI
            document.getElementById('imgUrl0').value = p.images[0] || '';
            document.getElementById('imgUrl1').value = p.images[1] || '';
            document.getElementById('imgUrl2').value = p.images[2] || '';
            
            resetView(); // Resetea zoom y posición
            updateViewerUI();

            document.getElementById('productName').value = p.name;
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productVisible').checked = p.visible;

            const s = p.specs || {};
            document.getElementById('specColor').value = s.color || '';
            document.getElementById('specMaterial').value = s.material || '';
            document.getElementById('specDimensions').value = s.dimensions || '';
            document.getElementById('specWeight').value = s.weight || '';
            document.getElementById('specModel').value = s.model || '';

            switchTab('tabGeneral');
            document.getElementById('catalogModal').classList.add('show');
        }

        function saveCatalogChanges() {
            if (currentEditingId === null) return;
            const index = products.findIndex(p => p.id === currentEditingId);
            if (index !== -1) {
                const newImages = [
                    document.getElementById('imgUrl0').value,
                    document.getElementById('imgUrl1').value,
                    document.getElementById('imgUrl2').value
                ];
                products[index].images = newImages;
                products[index].mainImageIndex = galleryState.mainIndex;
                products[index].imageUrl = newImages[galleryState.mainIndex]; // Legacy support
                products[index].description = document.getElementById('productDescription').value;
                products[index].visible = document.getElementById('productVisible').checked;
                products[index].specs = {
                    color: document.getElementById('specColor').value,
                    material: document.getElementById('specMaterial').value,
                    dimensions: document.getElementById('specDimensions').value,
                    weight: document.getElementById('specWeight').value,
                    model: document.getElementById('specModel').value
                };
                saveProducts();
                closeModal();
                alert('Cambios guardados correctamente');
            }
        }

        // ================================
        // UTILIDADES UI
        // ================================
        function switchView(viewName) {
            const list = document.getElementById('listView');
            const grid = document.getElementById('gridView');
            const btnList = document.getElementById('btnListView');
            const btnGrid = document.getElementById('btnGridView');
            if (viewName === 'list') {
                list.classList.add('active'); grid.classList.remove('active');
                btnList.classList.add('active'); btnGrid.classList.remove('active');
            } else {
                list.classList.remove('active'); grid.classList.add('active');
                btnList.classList.remove('active'); btnGrid.classList.add('active');
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            const index = tabId === 'tabGeneral' ? 0 : 1;
            document.querySelectorAll('.tab-btn')[index].classList.add('active');
        }

        function closeModal() {
            document.getElementById('catalogModal').classList.remove('show');
            currentEditingId = null;
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            updateThemeIcons(isDark);
        }

        function applySavedTheme() {
            const saved = localStorage.getItem('darkMode');
            if (saved === 'enabled') {
                document.body.classList.add('dark-mode');
                updateThemeIcons(true);
            }
        }

        function updateThemeIcons(isDark) {
            document.querySelector('.sun-icon').style.display = isDark ? 'none' : 'block';
            document.querySelector('.moon-icon').style.display = isDark ? 'block' : 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('catalogModal');
            if (event.target == modal) closeModal();
        }
    </script>
</body>
</html>