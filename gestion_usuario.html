<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Usuarios - Ciervo Administrativo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        /* Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(to bottom right, #f8fafc, #dbeafe, #e0e7ff);
            min-height: 100vh;
            color: #334155;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background: linear-gradient(to bottom right, #1a202c, #2d3748, #4a5568);
            color: #e2e8f0;
        }

        .glassmorphic-bar {
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            transition: background-color 0.3s, border-color 0.3s;
        }

        .dark-mode .glassmorphic-bar {
            background: rgba(26, 32, 44, 0.7);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .brand-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .brand-icon {
            position: relative;
            width: 48px;
            height: 48px;
            background: linear-gradient(to bottom right, #3b82f6, #9333ea);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 15px -3px rgba(59, 130, 246, 0.25);
        }

        .brand-icon::after {
            content: '';
            position: absolute;
            top: -4px;
            right: -4px;
            width: 16px;
            height: 16px;
            background: #10b981;
            border-radius: 50%;
            border: 2px solid white;
        }

        .brand-text h1 {
            font-size: 1.25rem;
            font-weight: bold;
            background: linear-gradient(to right, #1e293b, #64748b);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }

        .dark-mode .brand-text h1 {
            background: linear-gradient(to right, #e2e8f0, #cbd5e1);
            background-clip: text;
            -webkit-background-clip: text;
        }

        .brand-text p {
            font-size: 0.875rem;
            color: #64748b;
        }

        .dark-mode .brand-text p {
            color: #a0aec0;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .back-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.5);
            border: none;
            border-radius: 12px;
            color: #64748b;
            text-decoration: none;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            backdrop-filter: blur(8px);
        }

        .dark-mode .back-button {
            background: rgba(255, 255, 255, 0.1);
            color: #cbd5e1;
        }

        .back-button:hover {
            background: rgba(255, 255, 255, 0.8);
            color: #1e293b;
            transform: translateX(-2px);
        }

        .dark-mode .back-button:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
        }

        .main-content {
            padding: 2rem 0;
        }

        .module-header-section {
            text-align: center;
            margin-bottom: 2rem;
            padding: 2rem 0;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(219, 234, 254, 1);
            color: #1d4ed8;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 1rem;
        }

        .dark-mode .badge {
            background: rgba(59, 130, 246, 0.2);
            color: #90cdf4;
        }

        .module-title {
            font-size: 2.25rem;
            font-weight: bold;
            background: linear-gradient(to right, #1e293b, #1e40af, #7c3aed);
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            margin-bottom: 1rem;
        }

        .dark-mode .module-title {
            background: linear-gradient(to right, #e2e8f0, #90cdf4, #b794f4);
            background-clip: text;
            -webkit-background-clip: text;
        }

        .module-subtitle {
            font-size: 1.125rem;
            color: #64748b;
            max-width: 48rem;
            margin: 0 auto;
        }

        .dark-mode .module-subtitle {
            color: #a0aec0;
        }

        .tab-container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid #e2e8f0;
            overflow: hidden;
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        .dark-mode .tab-container {
            background: #2d3748;
            border: 1px solid #4a5568;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .tab-navigation {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.3s, border-color 0.3s;
        }

        .dark-mode .tab-navigation {
            background: #4a5568;
            border-bottom: 1px solid #64748b;
        }

        .tab-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1.25rem 1rem;
            background: none;
            border: none;
            color: #64748b;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .dark-mode .tab-button {
            color: #cbd5e1;
        }

        .tab-button:hover {
            background: rgba(59, 130, 246, 0.05);
            color: #3b82f6;
        }

        .dark-mode .tab-button:hover {
            background: rgba(59, 130, 246, 0.2);
            color: #90cdf4;
        }

        .tab-button.active {
            background: white;
            color: #3b82f6;
            box-shadow: 0 -2px 0 0 #3b82f6 inset;
        }

        .dark-mode .tab-button.active {
            background: #2d3748;
            color: #90cdf4;
            box-shadow: 0 -2px 0 0 #90cdf4 inset;
        }

        .tab-content-area {
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Users List Styles */
        .list-header {
            margin-bottom: 2rem;
        }

        .search-section {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .search-section {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }

        .search-input-container {
            position: relative;
            flex: 1;
        }

        .search-input-container svg {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
        }

        .dark-mode .search-input-container svg {
            color: #a0aec0;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 3rem;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            color: #1e293b;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .dark-mode .search-input {
            background: #4a5568;
            border: 1px solid #64748b;
            color: #e2e8f0;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark-mode .search-input:focus {
            border-color: #90cdf4;
            background: #2d3748;
            box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.2);
        }

        .filter-controls {
            display: flex;
            gap: 1rem;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            color: #1e293b;
            font-size: 0.875rem;
            min-width: 150px;
            transition: all 0.2s;
        }

        .dark-mode .filter-select {
            background: #4a5568;
            border: 1px solid #64748b;
            color: #e2e8f0;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark-mode .filter-select:focus {
            border-color: #90cdf4;
            background: #2d3748;
            box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.2);
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .user-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
            cursor: pointer;
            position: relative;
        }

        .dark-mode .user-card {
            background: #2d3748;
            border: 1px solid #4a5568;
        }

        .user-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            border-color: #3b82f6;
        }

        .dark-mode .user-card:hover {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
            border-color: #90cdf4;
        }

        .user-card-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            background: linear-gradient(to bottom right, #3b82f6, #9333ea);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .user-info h4 {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .dark-mode .user-info h4 {
            color: #e2e8f0;
        }

        .user-info p {
            font-size: 0.875rem;
            color: #64748b;
        }

        .dark-mode .user-info p {
            color: #a0aec0;
        }

        .user-card-body {
            margin-bottom: 1rem;
        }

        .user-detail {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .dark-mode .user-detail {
            color: #a0aec0;
        }

        .user-card-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .role-admin {
            background: rgba(251, 146, 60, 0.1);
            color: #ea580c;
            border: 1px solid rgba(251, 146, 60, 0.2);
        }

        .dark-mode .role-admin {
            background: rgba(251, 146, 60, 0.2);
            color: #fbd38d;
            border: 1px solid rgba(251, 146, 60, 0.3);
        }

        .role-seller {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .dark-mode .role-seller {
            background: rgba(16, 185, 129, 0.2);
            color: #81e6d9;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-active .status-dot {
            background: #10b981;
        }

        .status-inactive .status-dot {
            background: #ef4444;
        }

        .status-pending .status-dot {
            background: #f59e0b;
        }

        .status-active {
            color: #059669;
        }

        .dark-mode .status-active {
            color: #81e6d9;
        }

        .status-inactive {
            color: #dc2626;
        }

        .dark-mode .status-inactive {
            color: #feb2b2;
        }

        .status-pending {
            color: #d97706;
        }

        .dark-mode .status-pending {
            color: #fbd38d;
        }

        /* Delete button */
        .delete-user-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(239, 68, 68, 0.1);
            border: none;
            border-radius: 8px;
            padding: 0.5rem;
            color: #dc2626;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dark-mode .delete-user-btn {
            background: rgba(239, 68, 68, 0.2);
            color: #feb2b2;
        }

        .delete-user-btn:hover {
            background: rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        .dark-mode .delete-user-btn:hover {
            background: rgba(239, 68, 68, 0.3);
        }

        /* Registration Form Styles */
        /* Removed .registration-container styles for background, border, shadow */
        .registration-form-wrapper { /* New wrapper for the form content */
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 0; /* Adjust padding as needed */
            position: relative;
            overflow: hidden;
        }

        .registration-form-wrapper::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(to right, #3b82f6, #9333ea, #06b6d4);
        }

        .form-section {
            margin-bottom: 2rem;
            background: white; /* Add background to sections */
            border-radius: 16px; /* Add border-radius to sections */
            padding: 1.5rem; /* Add padding to sections */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); /* Add subtle shadow to sections */
            border: 1px solid #e2e8f0; /* Add border to sections */
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        .dark-mode .form-section {
            background: #2d3748;
            border: 1px solid #4a5568;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        .form-section:not(:last-child) {
            margin-bottom: 1.5rem; /* Space between sections */
        }


        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dark-mode .section-title {
            color: #e2e8f0;
        }

        .section-icon {
            padding: 0.5rem;
            background: linear-gradient(to bottom right, #dbeafe, #e0e7ff);
            border-radius: 8px;
        }

        .dark-mode .section-icon {
            background: linear-gradient(to bottom right, #4a5568, #64748b);
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .form-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dark-mode .form-label {
            color: #cbd5e1;
        }

        .required {
            color: #ef4444;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 12px;
            color: #1e293b;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .dark-mode .form-input, .dark-mode .form-select, .dark-mode .form-textarea {
            background: #4a5568;
            border: 1px solid #64748b;
            color: #e2e8f0;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark-mode .form-input:focus, .dark-mode .form-select:focus, .dark-mode .form-textarea:focus {
            border-color: #90cdf4;
            background: #2d3748;
            box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.2);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .input-with-icon {
            position: relative;
        }

        .input-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #94a3b8;
            cursor: pointer;
            transition: color 0.2s;
        }

        .dark-mode .input-icon {
            color: #a0aec0;
        }

        .input-icon:hover {
            color: #64748b;
        }

        .dark-mode .input-icon:hover {
            color: #cbd5e1;
        }

        .role-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }

        .role-option {
            position: relative;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .dark-mode .role-option {
            background: #4a5568;
            border: 2px solid #64748b;
        }

        .role-option:hover {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.05);
        }

        .dark-mode .role-option:hover {
            border-color: #90cdf4;
            background: rgba(59, 130, 246, 0.2);
        }

        .role-option.selected {
            border-color: #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .dark-mode .role-option.selected {
            border-color: #90cdf4;
            background: rgba(59, 130, 246, 0.3);
            box-shadow: 0 0 0 3px rgba(144, 205, 244, 0.2);
        }

        .role-icon {
            width: 48px;
            height: 48px;
            margin: 0 auto 0.75rem;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
        }

        .role-option:hover .role-icon {
            transform: scale(1.1);
        }

        .admin-icon {
            background: linear-gradient(to bottom right, #f59e0b, #d97706);
        }

        .seller-icon {
            background: linear-gradient(to bottom right, #10b981, #059669);
        }

        .role-title {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }

        .dark-mode .role-title {
            color: #e2e8f0;
        }

        .role-description {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.4;
        }

        .dark-mode .role-description {
            color: #a0aec0;
        }

        .permissions-preview {
            background: rgba(239, 246, 255, 0.5);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .dark-mode .permissions-preview {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .permissions-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
        }

        .dark-mode .permissions-title {
            color: #90cdf4;
        }

        .permissions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .permission-tag {
            padding: 0.25rem 0.75rem;
            background: rgba(59, 130, 246, 0.1);
            color: #1e40af;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .dark-mode .permission-tag {
            background: rgba(59, 130, 246, 0.2);
            color: #90cdf4;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .form-actions {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid #e2e8f0;
        }

        .dark-mode .form-actions {
            border-top: 1px solid #4a5568;
        }

        @media (min-width: 640px) {
            .form-actions {
                flex-direction: row;
                justify-content: flex-end; /* Align buttons to the right */
            }
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex: 1;
            justify-content: flex-end;
        }

        .btn {
            padding: 0.75rem 2rem;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #64748b;
        }

        .dark-mode .btn-secondary {
            background: #4a5568;
            color: #e2e8f0;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #475569;
        }

        .dark-mode .btn-secondary:hover {
            background: #64748b;
            color: #f8fafc;
        }

        .btn-primary {
            background: linear-gradient(to right, #3b82f6, #6366f1);
            color: white;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25);
        }

        .dark-mode .btn-primary {
            background: linear-gradient(to right, #6366f1, #9333ea);
            box-shadow: 0 4px 14px 0 rgba(99, 102, 241, 0.35);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.35);
        }

        .dark-mode .btn-primary:hover {
            box-shadow: 0 8px 25px 0 rgba(99, 102, 241, 0.45);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.25);
        }

        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .validation-error {
            color: #ef4444;
        }

        .dark-mode .validation-error {
            color: #feb2b2;
        }

        .validation-success {
            color: #10b981;
        }

        .dark-mode .validation-success {
            color: #81e6d9;
        }

        .form-info {
            background: rgba(239, 246, 255, 0.8);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .dark-mode .form-info {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .info-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #1e40af;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dark-mode .info-title {
            color: #90cdf4;
        }

        .info-text {
            font-size: 0.875rem;
            color: #64748b;
            line-height: 1.5;
        }

        .dark-mode .info-text {
            color: #a0aec0;
        }

        .password-strength {
            margin-top: 0.5rem;
        }

        .strength-label {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }

        .dark-mode .strength-label {
            color: #a0aec0;
        }

        .strength-bar {
            height: 4px;
            background: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
        }

        .dark-mode .strength-bar {
            background: #64748b;
        }

        .strength-fill {
            height: 100%;
            width: 0%;
            transition: all 0.3s;
            border-radius: 2px;
        }

        .strength-weak .strength-fill {
            width: 25%;
            background: #ef4444;
        }

        .strength-fair .strength-fill {
            width: 50%;
            background: #f59e0b;
        }

        .strength-good .strength-fill {
            width: 75%;
            background: #3b82f6;
        }

        .strength-strong .strength-fill {
            width: 100%;
            background: #10b981;
        }

        /* Roles Management Styles */
        .roles-container h3 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 2rem;
            text-align: center;
        }

        .dark-mode .roles-container h3 {
            color: #e2e8f0;
        }

        .roles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        .role-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
        }

        .dark-mode .role-card {
            background: #2d3748;
            border: 1px solid #4a5568;
        }

        .role-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.15);
        }

        .dark-mode .role-card:hover {
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
        }

        .role-header {
            margin-bottom: 1.5rem;
        }

        .role-icon-large {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .admin-gradient {
            background: linear-gradient(to bottom right, #f59e0b, #d97706);
        }

        .seller-gradient {
            background: linear-gradient(to bottom right, #10b981, #059669);
        }

        .role-header h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1e293b;
        }

        .dark-mode .role-header h4 {
            color: #e2e8f0;
        }

        .role-permissions-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
        }

        .permission-badge {
            padding: 0.375rem 0.75rem;
            background: rgba(239, 246, 255, 1);
            color: #1e40af;
            font-size: 0.75rem;
            font-weight: 500;
            border-radius: 9999px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .dark-mode .permission-badge {
            background: rgba(59, 130, 246, 0.2);
            color: #90cdf4;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        /* Modal de Edici√≥n de Usuario */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s;
        }

        .dark-mode .modal-content {
            background: #2d3748;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: #1e293b;
        }

        .dark-mode .modal-header h3 {
            color: #e2e8f0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #64748b;
        }

        .dark-mode .modal-close {
            color: #a0aec0;
        }

        /* Admin password toggle */
        .admin-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: #f1f5f9;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        .dark-mode .admin-toggle {
            background: #4a5568;
        }

        .toggle-label {
            font-size: 0.875rem;
            color: #64748b;
        }

        .dark-mode .toggle-label {
            color: #cbd5e1;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: .4s;
            border-radius: 24px;
        }

        .dark-mode .toggle-slider {
            background-color: #64748b;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #3b82f6;
        }

        .dark-mode input:checked + .toggle-slider {
            background-color: #90cdf4;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(26px);
        }

        /* Responsive adjustments */
        @media (max-width: 767px) {
            .module-title {
                font-size: 1.875rem;
            }
            
            .tab-navigation {
                flex-direction: column;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-select {
                min-width: auto;
            }
            
            .users-grid {
                grid-template-columns: 1fr;
            }
            
            .registration-form-wrapper { /* Adjusted for new wrapper */
                padding: 1.5rem 0;
                margin: 0 1rem;
            }
            
            .form-grid {
                gap: 1rem;
            }
            
            .role-selector {
                grid-template-columns: 1fr;
            }
        }

        .hidden {
            display: none;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid #f3f4f6;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .dark-mode .loading::after {
            border: 2px solid #a0aec0;
            border-top: 2px solid #90cdf4;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            background: none;
            border: none;
            color: inherit; /* Inherit color from parent for better integration */
            cursor: pointer;
            font-size: 1.25rem;
            margin-right: 0.5rem; /* Adjusted margin to fit next to back button */
            padding: 0.5rem; /* Add padding for easier clicking */
            border-radius: 8px; /* Slightly rounded corners */
            transition: background-color 0.2s, color 0.2s;
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.2); /* Subtle hover effect */
        }

        .dark-mode .dark-mode-toggle {
            color: inherit; /* Inherit color from parent */
        }

        .dark-mode .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="glassmorphic-bar">
        <div class="container">
            <div class="top-bar">
                <!-- Brand Section -->
                <div class="brand-section">
                    <div class="brand-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v2a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></svg>
                    </div>
                    <div class="brand-text">
                        <h1>Ciervo Administrativo</h1>
                        <p>Sistema de Gesti√≥n Empresarial</p>
                    </div>
                </div>

                <!-- Navigation Actions -->
                <div class="nav-actions">
                    <button id="darkModeToggle" class="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="sun-icon"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M4.93 19.07l1.41-1.41"/><path d="M17.66 6.34l1.41-1.41"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="moon-icon hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
                    </button>
                    <a href="menu.html" class="back-button">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                        Volver al Men√∫
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container main-content">
        <!-- Module Header -->
        <div class="module-header-section">
            <div class="badge">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <span>Gesti√≥n de Usuarios</span>
            </div>
            <h2 class="module-title">Administraci√≥n de Usuarios</h2>
            <p class="module-subtitle">
                Gestiona usuarios, roles y permisos del sistema empresarial
            </p>
        </div>

        <!-- User Management Tabs -->
        <div class="tab-container">
            <div class="tab-navigation">
                <button class="tab-button active" onclick="switchUserTab('list')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    Lista de Usuarios
                </button>
                <button class="tab-button" onclick="switchUserTab('register')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M12 8v8m-4-4h8"/>
                    </svg>
                    Registrar Usuario
                </button>
                <button class="tab-button" onclick="switchUserTab('roles')">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.582a.5.5 0 0 1 0 .962L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0L9.937 15.5Z"/>
                    </svg>
                    Gesti√≥n de Roles
                </button>
            </div>

            <!-- Tab Content -->
            <div class="tab-content-area">
                <!-- Users List Tab -->
                <div class="tab-content active" id="users-list-tab">
                    <div class="users-list-container">
                        <div class="list-header">
                            <div class="search-section">
                                <div class="search-input-container">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="m21 21-4.35-4.35"/>
                                    </svg>
                                    <input type="text" placeholder="Buscar usuarios..." class="search-input" id="userSearch">
                                </div>
                                <div class="filter-controls">
                                    <select class="filter-select" id="roleFilter">
                                        <option value="">Todos los roles</option>
                                        <option value="Administrador">Administrador</option>
                                        <option value="Vendedor">Vendedor</option>
                                    </select>
                                    <select class="filter-select" id="statusFilter">
                                        <option value="">Todos los estados</option>
                                        <option value="active">Activo</option>
                                        <option value="inactive">Inactivo</option>
                                        <option value="pending">Pendiente</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="users-grid" id="usersGrid">
                            <!-- Users will be populated here from Firebase -->
                        </div>
                    </div>
                </div>

                <!-- User Registration Tab -->
                <div class="tab-content" id="user-register-tab">
                    <div class="registration-form-wrapper">
                        <!-- Info Banner -->
                        <div class="form-info">
                            <div class="info-title">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                                Informaci√≥n Importante
                            </div>
                            <p class="info-text">
                                Complete todos los campos requeridos para crear un nuevo usuario. Los usuarios tendr√°n acceso inmediato al sistema seg√∫n el rol asignado.
                            </p>
                        </div>

                        <form id="registration-form" onsubmit="handleSubmit(event)">
                            <!-- Personal Information -->
                            <div class="form-section">
                                <h3 class="section-title">
                                    <div class="section-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                    </div>
                                    Informaci√≥n Personal
                                </h3>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label" for="firstName">
                                            Nombre <span class="required">*</span>
                                        </label>
                                        <input type="text" id="firstName" name="firstName" class="form-input" required 
                                               placeholder="Ingrese el nombre" onblur="validateField(this)">
                                        <div class="validation-message" id="firstName-message"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="lastName">
                                            Apellido <span class="required">*</span>
                                        </label>
                                        <input type="text" id="lastName" name="lastName" class="form-input" required 
                                               placeholder="Ingrese el apellido" onblur="validateField(this)">
                                        <div class="validation-message" id="lastName-message"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="email">
                                            Email <span class="required">*</span>
                                        </label>
                                        <input type="email" id="email" name="email" class="form-input" required 
                                               placeholder="usuario@empresa.com" onblur="validateField(this)">
                                        <div class="validation-message" id="email-message"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="phone">
                                            Tel√©fono
                                        </label>
                                        <input type="tel" id="phone" name="phone" class="form-input" 
                                               placeholder="+58 414 123 4567" onblur="validateField(this)">
                                        <div class="validation-message" id="phone-message"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="document">
                                            C√©dula/Documento <span class="required">*</span>
                                        </label>
                                        <input type="text" id="document" name="document" class="form-input" required 
                                               placeholder="V-12345678" onblur="validateField(this)">
                                        <div class="validation-message" id="document-message"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="position">
                                            Cargo/Posici√≥n
                                        </label>
                                        <input type="text" id="position" name="position" class="form-input" 
                                               placeholder="Ej: Gerente de Ventas">
                                    </div>
                                </div>
                            </div>

                            <!-- Account Information -->
                            <div class="form-section">
                                <h3 class="section-title">
                                    <div class="section-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="m7 11V7a5 5 0 0 1 10 0v4"/></svg>
                                    </div>
                                    Informaci√≥n de Cuenta
                                </h3>
                                
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label class="form-label" for="username">
                                            Nombre de Usuario <span class="required">*</span>
                                        </label>
                                        <input type="text" id="username" name="username" class="form-input" required 
                                               placeholder="usuario123" onblur="validateField(this)" oninput="checkUsername(this)">
                                        <div class="validation-message" id="username-message"></div>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="password">
                                            Contrase√±a <span class="required">*</span>
                                        </label>
                                        <div class="input-with-icon">
                                            <input type="password" id="password" name="password" class="form-input" required 
                                                   placeholder="Contrase√±a segura" oninput="checkPasswordStrength(this)" onblur="validateField(this)">
                                            <svg class="input-icon" onclick="togglePassword('password')" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                        </div>
                                        <div class="password-strength" id="password-strength">
                                            <div class="strength-label">Fortaleza de contrase√±a</div>
                                            <div class="strength-bar">
                                                <div class="strength-fill"></div>
                                            </div>
                                        </div>
                                        <div class="validation-message" id="password-message"></div>
                                    </div>

                                    <div class="form-group full-width">
                                        <label class="form-label" for="confirmPassword">
                                            Confirmar Contrase√±a <span class="required">*</span>
                                        </label>
                                        <div class="input-with-icon">
                                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-input" required 
                                                   placeholder="Confirme su contrase√±a" onblur="validateField(this)">
                                            <svg class="input-icon" onclick="togglePassword('confirmPassword')" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                        </div>
                                        <div class="validation-message" id="confirmPassword-message"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Role Selection -->
                            <div class="form-section">
                                <h3 class="section-title">
                                    <div class="section-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.582a.5.5 0 0 1 0 .962L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0L9.937 15.5Z"/></svg>
                                    </div>
                                    Rol y Permisos
                                </h3>
                                
                                <div class="role-selector">
                                    <div class="role-option" onclick="selectRole('Administrador')" data-role="Administrador">
                                        <div class="role-icon admin-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m8 6 4-4 4 4"/><path d="M12 2v10.3a4 4 0 0 1-1.172 2.872L4 22"/><path d="m20 22-6.928-6.928A4 4 0 0 1 12 12.3"/></svg>
                                        </div>
                                        <div class="role-title">üëë Administrador</div>
                                        <div class="role-description">
                                            Control total del sistema, gesti√≥n de usuarios y configuraciones avanzadas
                                        </div>
                                    </div>

                                    <div class="role-option" onclick="selectRole('Vendedor')" data-role="Vendedor">
                                        <div class="role-icon seller-icon">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57L20.9 9.35H4.12"/></svg>
                                        </div>
                                        <div class="role-title">üë§ Vendedor</div>
                                        <div class="role-description">
                                            Gesti√≥n de ventas, clientes y operaciones comerciales b√°sicas
                                        </div>
                                    </div>
                                </div>

                                <input type="hidden" id="selectedRole" name="role" required>
                                
                                <div class="permissions-preview" id="permissions-preview" style="display: none;">
                                    <div class="permissions-title">Permisos incluidos:</div>
                                    <div class="permissions-list" id="permissions-list">
                                        <!-- Dynamic permissions will be inserted here -->
                                    </div>
                                </div>
                            </div>

                            <!-- Additional Information -->
                            <div class="form-section">
                                <h3 class="section-title">
                                    <div class="section-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg>
                                    </div>
                                    Informaci√≥n Adicional
                                </h3>
                                
                                <div class="form-grid">
                                    <div class="form-group full-width">
                                        <label class="form-label" for="notes">
                                            Notas/Observaciones
                                        </label>
                                        <textarea id="notes" name="notes" class="form-textarea" 
                                                  placeholder="Informaci√≥n adicional sobre el usuario (opcional)"></textarea>
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="startDate">
                                            Fecha de Inicio
                                        </label>
                                        <input type="date" id="startDate" name="startDate" class="form-input">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="status">
                                            Estado Inicial
                                        </label>
                                        <select id="status" name="status" class="form-select">
                                            <option value="active">Activo</option>
                                            <option value="inactive">Inactivo</option>
                                            <option value="pending">Pendiente</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Form Actions -->
                            <div class="form-actions">
                                <div class="button-group">
                                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
                                        Limpiar Formulario
                                    </button>
                                    <button type="submit" class="btn btn-primary" id="submit-button">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        Crear Usuario
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Roles Management Tab -->
                <div class="tab-content" id="roles-management-tab">
                    <div class="roles-container">
                        <h3>Configuraci√≥n de Roles y Permisos</h3>
                        <div class="roles-grid">
                            <div class="role-card">
                                <div class="role-header">
                                    <div class="role-icon-large admin-gradient">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <path d="m8 6 4-4 4 4"/>
                                            <path d="M12 2v10.3a4 4 0 0 1-1.172 2.872L4 22"/>
                                            <path d="m20 22-6.928-6.928A4 4 0 0 1 12 12.3"/>
                                        </svg>
                                    </div>
                                    <h4>Administrador</h4>
                                </div>
                                <div class="role-permissions-list">
                                    <span class="permission-badge">Gesti√≥n completa</span>
                                    <span class="permission-badge">Configuraci√≥n sistema</span>
                                    <span class="permission-badge">Reportes avanzados</span>
                                    <span class="permission-badge">Gesti√≥n usuarios</span>
                                </div>
                            </div>

                            <div class="role-card">
                                <div class="role-header">
                                    <div class="role-icon-large seller-gradient">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <circle cx="8" cy="21" r="1"/>
                                            <circle cx="19" cy="21" r="1"/>
                                            <path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57L20.9 9.35H4.12"/>
                                        </svg>
                                    </div>
                                    <h4>Vendedor</h4>
                                </div>
                                <div class="role-permissions-list">
                                    <span class="permission-badge">Gesti√≥n ventas</span>
                                    <span class="permission-badge">Consulta inventario</span>
                                    <span class="permission-badge">Gesti√≥n clientes</span>
                                    <span class="permission-badge">Cat√°logo productos</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edici√≥n de Usuario -->
    <div class="modal-overlay hidden" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Editar Usuario</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            
            <!-- Admin Mode Toggle -->
            <div class="admin-toggle">
                <span class="toggle-label">Modo Administrador</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="adminModeToggle" onchange="toggleAdminMode()">
                    <span class="toggle-slider"></span>
                </label>
            </div>
            
            <form id="edit-user-form" onsubmit="handleEditSubmit(event)">
                <input type="hidden" id="edit-user-id" name="id">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="edit-firstName">
                            Nombre <span class="required">*</span>
                        </label>
                        <input type="text" id="edit-firstName" name="firstName" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-lastName">
                            Apellido <span class="required">*</span>
                        </label>
                        <input type="text" id="edit-lastName" name="lastName" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-email">
                            Email <span class="required">*</span>
                        </label>
                        <input type="email" id="edit-email" name="email" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-phone">
                            Tel√©fono
                        </label>
                        <input type="tel" id="edit-phone" name="phone" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-document">
                            C√©dula/Documento <span class="required">*</span>
                        </label>
                        <input type="text" id="edit-document" name="document" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-position">
                            Cargo/Posici√≥n
                        </label>
                        <input type="text" id="edit-position" name="position" class="form-input">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-username">
                            Nombre de Usuario <span class="required">*</span>
                        </label>
                        <input type="text" id="edit-username" name="username" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-password">
                            Contrase√±a <span class="required">*</span>
                        </label>
                        <div class="input-with-icon">
                            <input type="password" id="edit-password" name="password" class="form-input" required>
                            <svg class="input-icon" onclick="togglePassword('edit-password')" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-role">
                            Rol <span class="required">*</span>
                        </label>
                        <select id="edit-role" name="role" class="form-select" required>
                            <option value="Administrador">Administrador</option>
                            <option value="Vendedor">Vendedor</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="edit-status">
                            Estado
                        </label>
                        <select id="edit-status" name="status" class="form-select">
                            <option value="active">Activo</option>
                            <option value="inactive">Inactivo</option>
                            <option value="pending">Pendiente</option>
                        </select>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label" for="edit-notes">
                            Notas/Observaciones
                        </label>
                        <textarea id="edit-notes" name="notes" class="form-textarea"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <div class="button-group">
                        <button type="button" class="btn btn-danger" onclick="deleteUser()" style="background: #ef4444; color: white;">
                            Eliminar Usuario
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                            Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary">
                            Guardar Cambios
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCyaIC2-pCCQf_mJWGtG6v-0kA1l2Or2CQ",
            authDomain: "mini-market-ciervo-index.firebaseapp.com",
            databaseURL: "https://mini-market-ciervo-index-default-rtdb.firebaseio.com",
            projectId: "mini-market-ciervo-index",
            storageBucket: "mini-market-ciervo-index.firebasestorage.app",
            messagingSenderId: "828978506509",
            appId: "1:828978506509:web:52b6220033072038115e44"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Global variables
        let selectedRole = null;
        let formValidation = {
            firstName: false,
            lastName: false,
            email: false,
            document: false,
            username: false,
            password: false,
            confirmPassword: false,
            role: false
        };
        let isAdminMode = false;

        // Get current owner email from sessionStorage
        const propietarioActualEmail = sessionStorage.getItem('propietarioActual');

        if (!propietarioActualEmail) {
            alert('Error: No ha iniciado sesi√≥n como propietario. Ser√° redirigido a la p√°gina de login.');
            // window.location.href = 'pagina-de-login.html'; // Uncomment when login page is ready
        }

        // Role permissions configuration
        const rolePermissions = {
            'Administrador': [
                'Gesti√≥n completa de usuarios',
                'Configuraci√≥n del sistema',
                'Acceso a reportes avanzados',
                'Gesti√≥n de inventario',
                'Gesti√≥n de ventas',
                'Configuraci√≥n de empresa',
                'Herramientas de desarrollo',
                'Gesti√≥n de proveedores'
            ],
            'Vendedor': [
                'Gesti√≥n de ventas',
                'Consulta de inventario',
                'Gesti√≥n b√°sica de clientes',
                'Acceso al cat√°logo',
                'Calculadora de divisas'
            ]
        };

        // Initialize Lucide icons and other setup
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            } else {
                setTimeout(() => {
                    if (typeof lucide !== 'undefined') {
                        lucide.createIcons();
                    }
                }, 100);
            }
            
            const startDateInput = document.getElementById('startDate');
            if (startDateInput) {
                startDateInput.valueAsDate = new Date();
            }
            
            renderUsers();
            
            const searchInput = document.getElementById('userSearch');
            const roleFilter = document.getElementById('roleFilter');
            const statusFilter = document.getElementById('statusFilter');
            
            if (searchInput) {
                searchInput.addEventListener('input', filterUsers);
            }
            if (roleFilter) {
                roleFilter.addEventListener('change', filterUsers);
            }
            if (statusFilter) {
                statusFilter.addEventListener('change', filterUsers);
            }

            initDarkMode();
            updateSubmitButton();
        });

        // Dark Mode Functionality
        function initDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const sunIcon = darkModeToggle.querySelector('.sun-icon');
            const moonIcon = darkModeToggle.querySelector('.moon-icon');
            const isDarkMode = localStorage.getItem('darkMode') === 'enabled';

            if (isDarkMode) {
                document.body.classList.add('dark-mode');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-mode');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }

            darkModeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                const currentMode = document.body.classList.contains('dark-mode');
                localStorage.setItem('darkMode', currentMode ? 'enabled' : 'disabled');

                if (currentMode) {
                    sunIcon.classList.add('hidden');
                    moonIcon.classList.remove('hidden');
                } else {
                    sunIcon.classList.remove('hidden');
                    moonIcon.classList.add('hidden');
                }
            });
        }

        // Read users from Firebase
        function getUsersFromFirebase(callback) {
            if (!propietarioActualEmail) {
                callback([]);
                return;
            }
            db.ref('operadores').orderByChild('propietario').equalTo(propietarioActualEmail).once('value', snapshot => {
                const operadores = [];
                snapshot.forEach(childSnapshot => {
                    let operador = childSnapshot.val();
                    operador.id = childSnapshot.key; // Save Firebase unique key as id
                    operadores.push(operador);
                });
                callback(operadores);
            }).catch(error => {
                console.error("Error reading users from Firebase:", error);
                alert("Error al cargar los usuarios desde la base de datos.");
                callback([]);
            });
        }

        // Tab switching
        function switchUserTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            const targetButton = document.querySelector(`.tab-button[onclick="switchUserTab('${tabName}')"]`);
            const targetTabContent = document.getElementById(`${tabName === 'list' ? 'users-list' : tabName === 'register' ? 'user-register' : 'roles-management'}-tab`);

            if (targetButton) {
                targetButton.classList.add('active');
            }
            if (targetTabContent) {
                targetTabContent.classList.add('active');
            }
            
            if (tabName === 'list') {
                renderUsers();
            }
            
            if (tabName === 'register') {
                softResetForm();
            }
        }

        // Soft reset form (without confirmation)
        function softResetForm() {
            const form = document.getElementById('registration-form');
            if (form) {
                form.reset();
            }
            
            Object.keys(formValidation).forEach(key => {
                formValidation[key] = false;
            });
            
            document.querySelectorAll('.validation-message').forEach(el => {
                el.textContent = '';
                el.className = 'validation-message';
            });
            
            selectedRole = null;
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            const permissionsPreview = document.getElementById('permissions-preview');
            if (permissionsPreview) {
                permissionsPreview.style.display = 'none';
            }
            
            const strengthBar = document.querySelector('#password-strength .strength-bar');
            if (strengthBar) {
                strengthBar.className = 'strength-bar';
            }
            const strengthLabel = document.querySelector('#password-strength .strength-label');
            if (strengthLabel) {
                strengthLabel.textContent = 'Fortaleza de contrase√±a';
            }
            
            const startDateInput = document.getElementById('startDate');
            if (startDateInput) {
                startDateInput.valueAsDate = new Date();
            }
            
            updateSubmitButton();
        }

        // Render users in the list
        function renderUsers(filteredUsers = null) {
            const grid = document.getElementById('usersGrid');
            if (!grid) return;
            
            getUsersFromFirebase(allUsers => {
                const usersToRender = filteredUsers !== null ? filteredUsers : allUsers;

                if (usersToRender.length === 0) {
                    grid.innerHTML = `
                        <div class="no-users-message" style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-color-secondary, #64748b);">
                            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 1rem; color: var(--text-color-tertiary, #94a3b8);">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                            </svg>
                            <h3 style="margin-bottom: 0.5rem;">No hay usuarios registrados</h3>
                            <p>Utilice la pesta√±a "Registrar Usuario" para agregar nuevos usuarios al sistema.</p>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = usersToRender.map(user => `
                    <div class="user-card" onclick="editUser('${user.id}')">
                        <button class="delete-user-btn" onclick="event.stopPropagation(); deleteUserFromList('${user.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M3 6h18"/>
                                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                            </svg>
                        </button>
                        <div class="user-card-header">
                            <div class="user-avatar">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                    <circle cx="12" cy="7" r="4"/>
                                </svg>
                            </div>
                            <div class="user-info">
                                <h4>${user.firstName} ${user.lastName}</h4>
                                <p>${user.email}</p>
                            </div>
                        </div>
                        <div class="user-card-body">
                            <div class="user-detail">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                                </svg>
                                ${user.phone || 'No especificado'}
                            </div>
                            <div class="user-detail">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                    <polyline points="10,9 9,9 8,9"/>
                                </svg>
                                ${user.document}
                            </div>
                            <div class="user-detail">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <rect width="18" height="18" x="3" y="4" rx="2" ry="2"/>
                                    <line x1="16" y1="2" x2="16" y2="6"/>
                                    <line x1="8" y1="2" x2="8" y2="6"/>
                                    <line x1="3" y1="10" x2="21" y2="10"/>
                                </svg>
                                ${user.position || 'No especificado'}
                            </div>
                        </div>
                        <div class="user-card-footer">
                            <span class="user-role-badge ${user.role === 'Administrador' ? 'role-admin' : 'role-seller'}">
                                ${user.role}
                            </span>
                            <div class="user-status status-${user.status}">
                                <div class="status-dot"></div>
                                <span>${user.status === 'active' ? 'Activo' : user.status === 'inactive' ? 'Inactivo' : 'Pendiente'}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            });
        }

        // Filter users based on search and filters
        function filterUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            const roleFilter = document.getElementById('roleFilter').value;
            const statusFilter = document.getElementById('statusFilter').value;
            
            getUsersFromFirebase(allUsers => {
                const filteredUsers = allUsers.filter(user => {
                    const matchesSearch = user.firstName.toLowerCase().includes(searchTerm) ||
                                        user.lastName.toLowerCase().includes(searchTerm) ||
                                        user.email.toLowerCase().includes(searchTerm) ||
                                        user.document.toLowerCase().includes(searchTerm) ||
                                        user.username.toLowerCase().includes(searchTerm) ||
                                        (user.position && user.position.toLowerCase().includes(searchTerm));
                    const matchesRole = !roleFilter || user.role === roleFilter;
                    const matchesStatus = !statusFilter || user.status === statusFilter;
                    
                    return matchesSearch && matchesRole && matchesStatus;
                });
                renderUsers(filteredUsers);
            });
        }

        // Role selection
        function selectRole(role) {
            selectedRole = role;
            const selectedRoleInput = document.getElementById('selectedRole');
            if (selectedRoleInput) {
                selectedRoleInput.value = role;
            }
            formValidation.role = true;
            
            document.querySelectorAll('.role-option').forEach(option => {
                option.classList.remove('selected');
            });
            const selectedOption = document.querySelector(`[data-role="${role}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            showPermissions(role);
            updateSubmitButton();
        }

        function showPermissions(role) {
            const preview = document.getElementById('permissions-preview');
            const list = document.getElementById('permissions-list');
            
            if (!preview || !list) return;

            list.innerHTML = '';
            const permissions = rolePermissions[role];
            if (permissions) {
                permissions.forEach(permission => {
                    const tag = document.createElement('span');
                    tag.className = 'permission-tag';
                    tag.textContent = permission;
                    list.appendChild(tag);
                });
            }
            
            preview.style.display = 'block';
        }

        // Form validation
        function validateField(field) {
            const value = field.value.trim();
            const fieldName = field.name;
            const messageElement = document.getElementById(`${fieldName}-message`);
            
            let isValid = false;
            let message = '';
            
            switch (fieldName) {
                case 'firstName':
                case 'lastName':
                    isValid = value.length >= 2;
                    message = isValid ? '‚úì V√°lido' : '‚ö† M√≠nimo 2 caracteres';
                    break;
                    
                case 'email':
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    isValid = emailRegex.test(value);
                    message = isValid ? '‚úì Email v√°lido' : '‚ö† Formato de email inv√°lido';
                    break;
                    
                case 'document':
                    const docRegex = /^(?:[VEJPvejp]-?)?\d{6,9}$/;
                    isValid = docRegex.test(value);
                    message = isValid ? '‚úì Documento v√°lido' : '‚ö† Formato: V-12345678 o 12345678';
                    break;
                    
                case 'username':
                    isValid = value.length >= 4 && /^[a-zA-Z0-9_]+$/.test(value);
                    message = isValid ? '‚úì Usuario disponible' : '‚ö† Solo letras, n√∫meros y _';
                    if (isValid) {
                        checkUsername(field);
                        isValid = formValidation.username;
                    }
                    break;
                    
                case 'password':
                    isValid = value.length >= 8 && /[A-Z]/.test(value) && /[0-9]/.test(value) && /[^A-Za-z0-9]/.test(value);
                    message = isValid ? '‚úì Contrase√±a segura' : '‚ö† M√≠nimo 8 caracteres, 1 may√∫scula, 1 n√∫mero, 1 s√≠mbolo';
                    break;
                    
                case 'confirmPassword':
                    const passwordField = document.getElementById('password');
                    const password = passwordField ? passwordField.value : '';
                    isValid = value === password && value.length > 0;
                    message = isValid ? '‚úì Las contrase√±as coinciden' : '‚ö† Las contrase√±as no coinciden';
                    break;
                    
                case 'phone':
                    if (value) {
                        const phoneRegex = /^[\+]?[(]?[0-9]{3}[)]?[-\s\.]?[0-9]{3}[-\s\.]?[0-9]{4,6}$/;
                        isValid = phoneRegex.test(value);
                        message = isValid ? '‚úì Tel√©fono v√°lido' : '‚ö† Formato de tel√©fono inv√°lido';
                    } else {
                        isValid = true;
                        message = '';
                    }
                    break;
                default:
                    isValid = true;
                    break;
            }
            
            formValidation[fieldName] = isValid;
            
            if (messageElement) {
                messageElement.textContent = message;
                messageElement.className = `validation-message ${isValid ? 'validation-success' : 'validation-error'}`;
            }
            
            updateSubmitButton();
        }

        function checkUsername(field) {
            const username = field.value.trim();
            const messageElement = document.getElementById(`${field.id}-message`);
            
            getUsersFromFirebase(users => {
                const currentUserId = document.getElementById('edit-user-id') ? document.getElementById('edit-user-id').value : null;
                const isTaken = users.some(user => user.username === username && user.id !== currentUserId);
                
                if (isTaken) {
                    messageElement.textContent = '‚ö† Usuario no disponible';
                    messageElement.className = 'validation-message validation-error';
                    formValidation.username = false;
                } else if (username.length >= 4 && /^[a-zA-Z0-9_]+$/.test(username)) {
                    messageElement.textContent = '‚úì Usuario disponible';
                    messageElement.className = 'validation-message validation-success';
                    formValidation.username = true;
                } else {
                    formValidation.username = false;
                }
                updateSubmitButton();
            });
        }

        function checkPasswordStrength(field) {
            const password = field.value;
            const strengthElement = document.getElementById('password-strength');
            const strengthBar = strengthElement ? strengthElement.querySelector('.strength-bar') : null;
            const strengthLabel = strengthElement ? strengthElement.querySelector('.strength-label') : null;
            
            if (!strengthBar || !strengthLabel) return;

            let score = 0;
            if (password.length >= 8) score++;
            if (/[A-Z]/.test(password)) score++;
            if (/[0-9]/.test(password)) score++;
            if (/[^A-Za-z0-9]/.test(password)) score++;
            
            let strengthText = '';
            let strengthClass = '';
            
            if (password.length === 0) {
                strengthText = 'Fortaleza de contrase√±a';
                strengthClass = '';
            } else if (score <= 1) {
                strengthText = 'D√©bil';
                strengthClass = 'strength-weak';
            } else if (score === 2) {
                strengthText = 'Regular';
                strengthClass = 'strength-fair';
            } else if (score === 3) {
                strengthText = 'Buena';
                strengthClass = 'strength-good';
            } else {
                strengthText = 'Fuerte';
                strengthClass = 'strength-strong';
            }
            
            strengthBar.className = `strength-bar ${strengthClass}`;
            strengthLabel.textContent = `Fortaleza: ${strengthText}`;
        }

        function togglePassword(fieldId) {
            const field = document.getElementById(fieldId);
            const icon = field ? field.nextElementSibling : null;
            
            if (!field || !icon) return;

            if (field.type === 'password') {
                field.type = 'text';
                icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>';
            } else {
                field.type = 'password';
                icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/><path d="M12 12v.01"/></svg>';
            }
        }

        function updateSubmitButton() {
            const submitButton = document.getElementById('submit-button');
            if (!submitButton) return;

            const requiredFields = ['firstName', 'lastName', 'email', 'document', 'username', 'password', 'confirmPassword', 'role'];
            const allValid = requiredFields.every(field => formValidation[field]);
            
            submitButton.disabled = !allValid;
        }

        function resetForm() {
            if (confirm('¬øEst√° seguro de que desea limpiar todos los campos?')) {
                softResetForm();
            }
        }

        function handleSubmit(event) {
            event.preventDefault();
            
            const submitButton = document.getElementById('submit-button');
            const form = document.getElementById('registration-form');
            
            if (!submitButton || !form) return;

            const fieldsToValidate = ['firstName', 'lastName', 'email', 'phone', 'document', 'username', 'password', 'confirmPassword'];
            fieldsToValidate.forEach(fieldName => {
                const field = document.getElementById(fieldName);
                if (field) validateField(field);
            });
            if (!selectedRole) {
                formValidation.role = false;
            } else {
                formValidation.role = true;
            }
            updateSubmitButton();

            if (submitButton.disabled) {
                alert('Por favor, complete todos los campos requeridos y corrija los errores de validaci√≥n.');
                return;
            }

            submitButton.classList.add('loading');
            submitButton.disabled = true;
            
            const formData = new FormData(form);
            const userData = {
                propietario: propietarioActualEmail,
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone') || '',
                document: formData.get('document'),
                position: formData.get('position') || '',
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                notes: formData.get('notes') || '',
                startDate: formData.get('startDate'),
                status: formData.get('status'),
                createdAt: new Date().toISOString()
            };
            
            db.ref('operadores').push().set(userData)
                .then(() => {
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                    
                    alert(`‚úÖ Usuario creado exitosamente!\n\nNombre: ${userData.firstName} ${userData.lastName}\nUsuario: ${userData.username}\nRol: ${userData.role}\nEstado: ${userData.status}`);
                    
                    softResetForm();
                    switchUserTab('list');
                    // ---- INICIO DE LA CORRECCI√ìN ----
                    // Forzamos la recarga de la lista de usuarios inmediatamente.
                    renderUsers();
                    // ---- FIN DE LA CORRECCI√ìN ----
                })
                .catch(error => {
                    console.error("Error adding document: ", error);
                    alert("Error al crear el usuario. Por favor, intente de nuevo.");
                    submitButton.classList.remove('loading');
                    submitButton.disabled = false;
                });
        }

        // Edit user functionality
        function editUser(userId) {
            db.ref('operadores/' + userId).once('value')
                .then(snapshot => {
                    const user = snapshot.val();
                    if (!user) {
                        alert('Usuario no encontrado.');
                        return;
                    }
                    
                    document.getElementById('edit-user-id').value = userId;
                    document.getElementById('edit-firstName').value = user.firstName;
                    document.getElementById('edit-lastName').value = user.lastName;
                    document.getElementById('edit-email').value = user.email;
                    document.getElementById('edit-phone').value = user.phone || '';
                    document.getElementById('edit-document').value = user.document;
                    document.getElementById('edit-position').value = user.position || '';
                    document.getElementById('edit-username').value = user.username;
                    document.getElementById('edit-password').value = user.password;
                    document.getElementById('edit-role').value = user.role;
                    document.getElementById('edit-status').value = user.status;
                    document.getElementById('edit-notes').value = user.notes || '';
                    
                    isAdminMode = false;
                    const adminModeToggle = document.getElementById('adminModeToggle');
                    if (adminModeToggle) {
                        adminModeToggle.checked = false;
                    }
                    const editPasswordField = document.getElementById('edit-password');
                    if (editPasswordField) {
                        editPasswordField.type = 'password';
                    }
                    
                    const editUserModal = document.getElementById('editUserModal');
                    if (editUserModal) {
                        editUserModal.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error("Error fetching user for edit:", error);
                    alert("Error al cargar los datos del usuario para edici√≥n.");
                });
        }

        function closeEditModal() {
            const editUserModal = document.getElementById('editUserModal');
            if (editUserModal) {
                editUserModal.classList.add('hidden');
            }
        }

        function toggleAdminMode() {
            isAdminMode = document.getElementById('adminModeToggle').checked;
            const passwordField = document.getElementById('edit-password');
            
            if (passwordField) {
                if (isAdminMode) {
                    passwordField.type = 'text';
                } else {
                    passwordField.type = 'password';
                }
            }
        }

        function handleEditSubmit(event) {
            event.preventDefault();
            
            const form = event.target;
            const userId = document.getElementById('edit-user-id').value;
            const formData = new FormData(form);
            const userData = {
                propietario: propietarioActualEmail,
                firstName: formData.get('firstName'),
                lastName: formData.get('lastName'),
                email: formData.get('email'),
                phone: formData.get('phone') || '',
                document: formData.get('document'),
                position: formData.get('position') || '',
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role'),
                status: formData.get('status'),
                notes: formData.get('notes') || ''
            };
            
            if (!userData.firstName || !userData.lastName || !userData.email || !userData.document || !userData.username || !userData.password || !userData.role) {
                alert('Por favor, complete todos los campos requeridos en el formulario de edici√≥n.');
                return;
            }

            db.ref('operadores/' + userId).update(userData)
                .then(() => {
                    renderUsers();
                    closeEditModal();
                    alert('‚úÖ Usuario actualizado exitosamente!');
                })
                .catch(error => {
                    console.error("Error updating user:", error);
                    alert("Error al actualizar el usuario. Por favor, intente de nuevo.");
                });
        }

        function deleteUser() {
            const userId = document.getElementById('edit-user-id').value;
            
            if (confirm('¬øEst√° seguro de que desea eliminar este usuario? Esta acci√≥n no se puede deshacer.')) {
                db.ref('operadores/' + userId).remove()
                    .then(() => {
                        renderUsers();
                        closeEditModal();
                        alert('‚úÖ Usuario eliminado exitosamente!');
                    })
                    .catch(error => {
                        console.error("Error removing user:", error);
                        alert("Error al eliminar el usuario. Por favor, intente de nuevo.");
                    });
            }
        }

        function deleteUserFromList(userId) {
            if (confirm('¬øEst√° seguro de que desea eliminar este usuario? Esta acci√≥n no se puede deshacer.')) {
                db.ref('operadores/' + userId).remove()
                    .then(() => {
                        renderUsers();
                        alert('‚úÖ Usuario eliminado exitosamente!');
                    })
                    .catch(error => {
                        console.error("Error removing user:", error);
                        alert("Error al eliminar el usuario. Por favor, intente de nuevo.");
                    });
            }
        }
    </script>
</body>
</html>
